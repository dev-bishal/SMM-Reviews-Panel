---
import TextInput from "../../components[admin]/TextInput.astro";
import AdminLayout from "../../layouts/adminLayout.astro";
import Toastify from "toastify-js";

var messageToShow = "";

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        // console.log("Form Data at client side - ", data);

        const response = await fetch(Astro.site + "api/panels.json", {
            method: "POST",
            body: data,
        });

        const APIResponse = await response.json();
        if (APIResponse.message == "Data Saved Successfully") {
            messageToShow = "SMM Panel is saved. Click here to see all Saved SMM Panels";
        }
    } catch (error) {
        if (error instanceof Error) {
            console.error(error.message);
        }
    }
}
---

<AdminLayout pageName="New SMM Panels" pageTitle="New SMM Panels">
    <div class="formContainer w-full">
        <form method="post" class="flex gap-x-5 w-full">
            <div class="form-fields flex flex-col gap-y-4 w-[60%]">
                <TextInput
                    isRequired={true}
                    placeholder="XYZ SMM Panel"
                    textBoxId="panelTitle"
                    textLabelText="Panel Title"
                />

                <span class="flex items-center gap-4">
                    <label class="w-1/3 text-right" for=""
                        >Panel FeaturedImage *</label
                    >
                    <span
                        class="flex flex-col justify-center items-center gap-2 w-2/3"
                    >
                        <img
                            id="uploadedImage"
                            src="/assets/images/placeholderImage.jpg"
                            class="w-full h-[180px] object-cover rounded-md"
                        />
                        <input
                            id="uploadInput"
                            name="uploadInput"
                            type="file"
                            class="text-xs w-fit"
                            accept="image/*"
                        />
                    </span>
                </span>

                <TextInput
                    isRequired={true}
                    placeholder="@someapikey_likethis"
                    textBoxId="panelAPIKey"
                    textLabelText="Panel APIKey"
                />

                <TextInput
                    isRequired={true}
                    placeholder="API Url"
                    textBoxId="panelAPILink"
                    textLabelText="Panel API Link"
                />

                <TextInput
                    isRequired={true}
                    placeholder="https://somesmm.com"
                    textBoxId="panelWebsiteURL"
                    textLabelText="Panel Website URL"
                />
                <input type="hidden" name="imageName" id="imageName" />
                <input type="hidden" name="imageBase64" id="imageBase64" />
                <input type="hidden" name="imageFileType" id="imageFileType" />
            </div>

            <div class="form-tools w-[40%] flex justify-end">
                <button
                    class="size-fit px-5 py-3 text-white rounded-lg bg-[#5344f5] hover:bg-[#3d32b3]"
                    >Publish</button
                >
            </div>
        </form>
    </div>

    {
        messageToShow && 
        <span class="toast hidden" id="toast" data-message = {messageToShow}></span>
    }
</AdminLayout>

<script is:inline>
    document
        .getElementById("uploadInput")
        .addEventListener("change", function (event) {
            const file = event.target.files[0];

            if (file) {
                // console.log(file);
                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = function () {
                    const imageDataURL = reader.result;
                    // const imgbody = new Blob([imageDataURL] , {type : file.type})

                    document.getElementById("imageName").value = file.name;
                    document.getElementById("uploadedImage").src = imageDataURL;
                    document.getElementById("imageBase64").value =
                        imageDataURL.split("base64,")[1];
                    document.getElementById("imageFileType").value = file.type;

                    // console.log(imgbody);
                };
            }
        });

        try {
            Toastify( {
                    text: document.querySelector("#toast").getAttribute("data-message"),
                    duration: 3000,
                    destination: "/admin/SMMPanel",
                    close: true,
                    gravity: "bottom", // `top` or `bottom`
                    position: "right", // `left`, `center` or `right`
                    stopOnFocus: true, // Prevents dismissing of toast on hover
                    style: {
                        background: "linear-gradient(to right, #5344f5, #3dbbc9)",
                    },
                    onClick: function () {}, // Callback after click
                }).showToast();
            
        } catch (error) {
            console.log(error)
        }
</script>
